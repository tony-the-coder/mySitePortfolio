{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ project.title|default:"Portfolio Project" }} - Lehman Custom Construction{% endblock title %}

{% block meta_description %}
    {% firstof project.short_description project.details|striptags|truncatewords:25 "View this custom home project by Lehman Custom Construction." as final_meta_description %}
    {{ final_meta_description|striptags|truncatewords:30 }}
{% endblock meta_description %}

{% block hero_section %}
{# --- Hero Section for Portfolio Detail --- #}
{% with first_image_url=project.get_first_image_url %}
    {% if first_image_url %}
    <section aria-labelledby="project-hero-title-{{ project.pk|default:'0' }}" class="relative h-[60vh] md:h-[75vh] lg:h-[85vh] bg-brand-charcoal group">
        <img src="{{ first_image_url }}" alt="Hero image for {{ project.title|default:'Project' }}" class="absolute inset-0 w-full h-full object-cover">
        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/40 to-transparent flex flex-col items-center justify-end text-center p-6 sm:p-8 md:p-12">
            <h1 id="project-hero-title-{{ project.pk|default:'0' }}" class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-3 leading-tight tracking-tight" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.6); font-family: var(--font-heading);">{{ project.title|default:"Portfolio Project" }}</h1>
            {% if project.category %}
                <p class="text-lg sm:text-xl md:text-2xl text-gray-200 font-medium hidden md:block" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.5); font-family: var(--font-body);">Style: {{ project.category.name }}</p>
            {% endif %}
        </div>
    </section>
    {% else %}
        <section aria-labelledby="project-hero-title-{{ project.pk|default:'0' }}" class="pt-32 md:pt-36 lg:pt-40 bg-brand-blue-dark text-center py-20 md:py-24 lg:py-28"> {# Fallback if no hero image #}
             <h1 id="project-hero-title-{{ project.pk|default:'0' }}" class="text-3xl md:text-4xl font-bold text-white px-4" style="font-family: var(--font-heading);">{{ project.title|default:"Portfolio Project" }}</h1>
             {% if project.category %}
                <p class="text-lg text-gray-300 hidden md:block" style="font-family: var(--font-body);">Style: {{ project.category.name }}</p>
            {% endif %}
        </section>
    {% endif %}
{% endwith %}
{% endblock hero_section %}

{% block breadcrumbs_block %}
    {% if breadcrumbs %}
        {% include 'partials/_breadcrumbs.html' with breadcrumbs=breadcrumbs %}
    {% endif %}
{% endblock breadcrumbs_block %}

{% block content %}
<div class="container mx-auto px-4 py-8 lg:py-12"
     x-data="portfolioDetailController([
        {% for image in project.images.all %}
            { src: '{{ image.image.url }}', caption: '{{ image.caption|default:''|escapejs }}' }{% if not forloop.last %},{% endif %}
        {% endfor %}
     ])">

    {% if project.details or project.location or project.year_completed or project.square_footage %}
        <div class="bg-white shadow-xl rounded-lg p-6 md:p-8 lg:p-10 my-8 md:my-12 max-w-4xl mx-auto">
            <h2 class="text-2xl lg:text-3xl font-semibold text-brand-charcoal mb-6 border-b border-gray-300 pb-4" style="font-family: var(--font-heading);">About This Project</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 text-sm text-brand-gray-text" style="font-family: var(--font-body);">
                {% if project.location %}
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-brand-gold">
                          <path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.145l.002-.001Zm.31-3.699a5.75 5.75 0 00-5.001-5.001 5.75 5.75 0 00-5.001 5.001c0 1.383.415 2.707 1.177 3.807l.09.141a5.75 5.75 0 008.67 0l.09-.141A5.75 5.75 0 0010 15.234Z" clip-rule="evenodd" />
                          <path fill-rule="evenodd" d="M10 8a2.5 2.5 0 100 5 2.5 2.5 0 000-5ZM7.5 10.5a2.5 2.5 0 115 0 2.5 2.5 0 01-5 0Z" clip-rule="evenodd" />
                        </svg>
                        <span>{{ project.location }}</span>
                    </div>
                {% endif %}
                {% if project.year_completed %}
                     <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-brand-gold">
                          <path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2Zm-1 5.5c0-.414.336-.75.75-.75h10.5a.75.75 0 01.75.75v6.5c0 .414-.336.75-.75.75H5.5a.75.75 0 01-.75-.75v-6.5Z" clip-rule="evenodd" />
                        </svg>
                        <span>Completed: {{ project.year_completed }}</span>
                    </div>
                {% endif %}
                 {% if project.square_footage %}
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-brand-gold">
                          <path d="M12.25 1a.75.75 0 00-.75.75v4.042L8.028 2.297a.75.75 0 00-1.056 1.056L9.944 6.25H5.75a.75.75 0 00-.75.75v1.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75v-1.5H10v1.5a.75.75 0 00.75.75h1.5a.75.75 0 00.75-.75V8h2.25a.75.75 0 00.75-.75v-1.5a.75.75 0 00-.75-.75H13V1.75a.75.75 0 00-.75-.75Z" />
                          <path fill-rule="evenodd" d="M2 11.25a.75.75 0 01.75-.75H5V8.75a.75.75 0 011.5 0v1.75H9V8.75a.75.75 0 011.5 0v1.75h2.25a.75.75 0 01.75.75v6a.75.75 0 01-.75.75H2.75a.75.75 0 01-.75-.75v-6Z" clip-rule="evenodd" />
                        </svg>
                         <span>{{ project.square_footage }} sq ft</span>
                    </div>
                {% endif %}
            </div>

            {% if project.details %}
            <div class="prose prose-lg max-w-none text-brand-gray-text" style="font-family: var(--font-body);">
                {{ project.details|safe|linebreaksbr }}
            </div>
            {% endif %}
        </div>
    {% endif %}

    <section class="my-8 md:my-12 lg:my-16">
        <h2 class="text-3xl lg:text-4xl font-semibold text-brand-charcoal mb-8 md:mb-10 text-center" style="font-family: var(--font-heading);">Project Gallery</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 md:gap-6 lg:gap-8">
            {% for image in project.images.all %}
                <div class="group cursor-pointer block relative overflow-hidden rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 ease-in-out"
                     @click="openImageInLightbox({{ forloop.counter0 }})">

                    <img src="{{ image.image.url }}"
                         alt="{{ image.caption|default:project.title|default:'Project image' }}"
                         class="w-full h-auto block object-cover transition-transform duration-300 ease-in-out group-hover:scale-[1.03] aspect-[4/3]">
                         {# Consider aspect-[3/2] or aspect-[16/9] as alternatives if 4/3 doesn't suit all images #}

                    {# Zoom icon overlay - subtle, appears on hover #}
                    <div class="absolute inset-0 flex items-center justify-center bg-brand-charcoal bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 ease-in-out opacity-0 group-hover:opacity-100 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-16 h-16 opacity-70 transform scale-75 group-hover:scale-100 transition-transform duration-300 ease-in-out">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
                        </svg>
                    </div>

                    {% if image.caption %}
                        <div class="absolute bottom-0 left-0 right-0 p-3 md:p-4 bg-gradient-to-t from-black/70 via-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-300 ease-in-out pointer-events-none">
                            <p class="text-white text-sm leading-tight" style="font-family: var(--font-body); text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">
                                {{ image.caption }}
                            </p>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                 <p class="text-brand-gray-text text-lg text-center py-12 md:col-span-2">{% trans "No images available for this project gallery." %}</p>
            {% endfor %}
        </div>
    </section>

    <div class="mt-12 lg:mt-16 text-center">
        <a href="{% url 'LehmanCustomConstruction:portfolio_list' %}"
           class="inline-block bg-brand-gold text-white font-semibold px-8 py-3 rounded-md hover:bg-brand-gold-dark focus:outline-none focus:ring-2 focus:ring-brand-gold focus:ring-offset-2 transition-all duration-150 ease-in-out transform hover:scale-105"
           style="font-family: var(--font-body); color: var(--color-brand-white) !important;">
            &larr; {% trans "Back to All Projects" %}
        </a>
    </div>

</div>
{% endblock content %}


{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('portfolioDetailController', (initialImages) => ({
            galleryImages: initialImages,
            openImageInLightbox(index) {
                if (this.galleryImages && this.galleryImages.length > 0 && this.galleryImages[index]) {
                    const imageToOpen = this.galleryImages[index];
                    this.$dispatch('open-lightbox', {
                        imagesArray: this.galleryImages, // Pass the whole array
                        startIndex: index,              // The index of the clicked image
                        // The lightbox component itself will use startIndex to get the initial src and caption
                    });
                } else {
                    console.warn('Lightbox: Image index out of bounds or galleryImages issue.', {index, count: this.galleryImages?.length});
                }
            }
        }));
    });
</script>
{% endblock extra_js %}

{% block extra_head %}
    {{ block.super }}
{% endblock extra_head %}